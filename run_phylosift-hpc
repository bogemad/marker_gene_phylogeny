#!/usr/bin/env python

import os, shutil, subprocess, re

base_path = os.path.dirname(os.path.realpath(__file__))
out = os.path.join(base_path, 'raw_data')
temp = os.path.join(base_path, 'temp', 'phylosift_scripts')
script_path = os.path.join(base_path, 'scripts')
out_files = os.listdir(out)

def make_temp_dirs(base_path, temp):
	if os.path.isdir(os.path.join(base_path, 'temp')) == False:
		os.mkdir(os.path.join(base_path, 'temp'))
	if os.path.isdir(temp):
		shutil.rmtree(temp)
	os.mkdir(temp)


for i, file in enumerate(out_files):
	new_file_name = re.sub(r'[^A-Za-z0-9_-]', '_', file)
	os.rename(os.path.join(out, file), os.path.join(out, new_file_name))
	subprocess.check_output(['qsub',
		'-N', 'Phylosift_{}'.format(i),
		'-l', 'ncpus=1',
		'-l', 'mem=8gb',
		'-l', 'walltime=2:00:00',
		'-q', 'smallq',
		'-o', os.path.join(base_path, 'logs', 'Phylosift_{}.out'.format(i)),
		'-e', os.path.join(base_path, 'logs', 'Phylosift_{}.err'.format(i)),
		'-v', 'base_path={}, out={}, file={}, num={}'.format(base_path, out, file, i),
		os.path.join(script_path, 'Phylosift_multirun.sh')])
